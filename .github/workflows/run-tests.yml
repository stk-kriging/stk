name: run-tests

on: [push, pull_request]

env:
  TEST_SCRIPT: >
    diary ('stk_runtests.log');
    stk_init;
    fprintf ('\n==========\n\n');
    ver;
    fprintf ('\n==========\n\n');
    results = stk_runtests ();
    fprintf ('\n==========\n\n');
    disp (results);
    fprintf ('\n==========\n\n');
    diary ('off');
    assert (results.n_total == (results.n_pass + results.n_xfail));

jobs:

  runtests-inplace-matlab:
    # Apparently only Ubuntu workers support MATLAB actions for now
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Only very recent releases are available:
        release: [R2021b, R2021a, R2020b, R2020a]
    steps:
      - name: Check out source repository
        uses: actions/checkout@v2
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v1
        with:
          release: ${{ matrix.release }}
      - name: Run test suite
        uses: matlab-actions/run-command@v1
        with:
          command: ${{ env.TEST_SCRIPT }}
      - name: "Upload artifact: log file"
        uses: actions/upload-artifact@v2
        with:
          name: runtests-inplace-matlab-${{ matrix.release }}-log
          path: stk_runtests.log

  runtests-inplace-octave:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install package
        run: |
          sudo apt-get update
          sudo apt-get -y install octave liboctave-dev
      - name: Run test suite
        run: octave --eval "${{ env.TEST_SCRIPT }}"
      - name: "Upload artifact: log file"
        uses: actions/upload-artifact@v2
        with:
          name: runtests-inplace-octave-log
          path: stk_runtests.log

  build-tarballs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Octave & tools
        run: |
          sudo apt-get update
          sudo apt-get -y install octave liboctave-dev quilt markdown
      - name: Install generate_html package
        run: octave --eval "pkg install -forge generate_html"
      - name: Build tarballs
        run: make release
      - name: "Upload artifacts: Octave package"
        uses: actions/upload-artifact@v2
        with:
          name: octpkg-tarball
          path: build/octaveforge/stk-*.tar.gz

  runtests-tarball-octpkg:
    runs-on: ubuntu-latest
    needs: build-tarballs
    steps:
      - name: Download build dir
        uses: actions/download-artifact@v2
        with:
          name: octpkg-tarball
      - name: TEMP
        run: find .
      - name: Get tarball name
        run: |
          OCTPKG_TARBALL=`ls stk-?.?.?.tar.gz`
          echo OCTPKG_TARBALL=$OCTPKG_TARBALL
          echo "octpkg_tarball=$OCTPKG_TARBALL" >> $GITHUB_ENV
      - name: Install Octave & tools
        run: |
          sudo apt-get update
          sudo apt-get -y install octave liboctave-dev
      - name: Install STK package
        run: octave --eval "pkg install ${{ env.octpkg_tarball }}"
      - name: Run test suite
        run: octave --eval "pkg load stk;  ${{ env.TEST_SCRIPT }}"
      - name: "Upload artifact: log file"
        uses: actions/upload-artifact@v2
        with:
          name: runtests-tarball-octpkg-log
          path: stk_runtests.log
